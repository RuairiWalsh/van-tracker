<!DOCTYPE html>
<html>
<head>
    <title>Van Tracker - Driver</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 50vh; }
        #controls { padding: 10px; }
        #status { margin: 10px 0; }
        .stop-marker { background-color: red; border-radius: 50%; }
        button { padding: 8px 16px; margin: 5px; }
        #dataOutput { width: 100%; height: 100px; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="controls">
        <button onclick="startTracking()">Start Tracking</button>
        <button onclick="stopTracking()">Stop Tracking</button>
        <button onclick="clearData()">Clear Data</button>
        <div id="status">Status: Not tracking</div>
        <div>Total Stops: <span id="stopCount">0</span></div>
        <div>Total Stop Time: <span id="stopTime">0</span> minutes</div>
        <h3>Data Log (Copy and Send to Manager if Requested):</h3>
        <textarea id="dataOutput" readonly></textarea>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, route, watchId, lastPosition, stopCount = 0, totalStopTime = 0;
        let trackingData = localStorage.getItem('trackingData') 
            ? localStorage.getItem('trackingData').split('\n') 
            : ['Timestamp,Latitude,Longitude,Speed(km/h)'];

        // Initialize map
        map = L.map('map').setView([51.505, -0.09], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        route = L.polyline([], {color: 'blue'}).addTo(map);

        // Load initial data
        document.getElementById('dataOutput').value = trackingData.join('\n');

        function startTracking() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }

            document.getElementById('status').textContent = 'Status: Tracking...';
            
            watchId = navigator.geolocation.watchPosition(
                position => {
                    const { latitude, longitude, timestamp, speed } = position.coords;
                    const currentSpeed = speed ? speed * 3.6 : 0; // Convert m/s to km/h
                    const point = {
                        lat: latitude,
                        lng: longitude,
                        timestamp: new Date(timestamp).toISOString(),
                        speed: currentSpeed
                    };

                    // Add to tracking data
                    trackingData.push(`${point.timestamp},${point.lat},${point.lng},${point.speed}`);
                    localStorage.setItem('trackingData', trackingData.join('\n'));
                    document.getElementById('dataOutput').value = trackingData.join('\n');

                    // Update map
                    route.addLatLng([latitude, longitude]);
                    map.panTo([latitude, longitude]);

                    // Detect stops
                    if (currentSpeed < 5) {
                        if (lastPosition && lastPosition.speed >= 5) {
                            stopCount++;
                            L.marker([latitude, longitude], {
                                icon: L.divIcon({
                                    className: 'stop-marker',
                                    html: '<div style="width:10px;height:10px;"></div>'
                                })
                            }).addTo(map);
                        }
                        if (lastPosition && lastPosition.speed < 5) {
                            const timeDiff = (timestamp - new Date(lastPosition.timestamp)) / 60000;
                            totalStopTime += timeDiff;
                        }
                    }

                    lastPosition = point;
                    updateStats();
                },
                error => {
                    document.getElementById('status').textContent = `Error: ${error.message}`;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        }

        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                document.getElementById('status').textContent = 'Status: Stopped';
                watchId = null;
            }
        }

        function clearData() {
            trackingData = ['Timestamp,Latitude,Longitude,Speed(km/h)'];
            localStorage.setItem('trackingData', trackingData.join('\n'));
            document.getElementById('dataOutput').value = trackingData.join('\n');
            route.setLatLngs([]);
            stopCount = 0;
            totalStopTime = 0;
            updateStats();
        }

        function updateStats() {
            document.getElementById('stopCount').textContent = stopCount;
            document.getElementById('stopTime').textContent = Math.round(totalStopTime);
        }

        window.onload = () => {
            navigator.geolocation.getCurrentPosition(
                pos => map.setView([pos.coords.latitude, pos.coords.longitude], 13),
                () => console.log('Initial position not available')
            );
        };
    </script>
</body>
</html>